
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grille Diagnostic Interactif - E32 MELEC</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0f172a; padding: 20px; min-height: 100vh; }
        .container { max-width: 1100px; margin: 0 auto; background: #0b1120; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.5); overflow: hidden; border: 1px solid #1e293b; }
        .header { background: linear-gradient(135deg, #1d4ed8, #22c55e); color: white; padding: 25px 30px; display:flex; justify-content:space-between; align-items:center; }
        .header h1 { font-size: 22px; }
        .scenario-select { padding: 15px 20px; background: #020617; color: #e5e7eb; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #1f2937; }
        .scenario-select select { padding: 8px 12px; border-radius: 8px; border:1px solid #4b5563; background:#020617; color:#e5e7eb; }
        .content { display:flex; flex-wrap:wrap; }
        .left, .right { padding: 20px 25px; }
        .left { flex: 1 1 380px; border-right:1px solid #1f2937; }
        .right { flex: 1 1 380px; background:#020617; }
        h2 { color:#e5e7eb; font-size:18px; margin-bottom:10px; }
        p, li, label, span { color:#9ca3af; font-size:14px; }
        .card { background:#020617; border-radius:12px; padding:15px 18px; margin-bottom:15px; border:1px solid #1f2937; }
        .badge { display:inline-block; padding:3px 8px; border-radius:999px; font-size:11px; margin-right:5px; }
        .badge-sympt { background:#1e40af; color:#e5e7eb; }
        .badge-step { background:#059669; color:#e5e7eb; }
        .btn { padding:10px 16px; border-radius:999px; border:none; cursor:pointer; font-weight:600; font-size:14px; margin:5px 3px; }
        .btn-primary { background:#2563eb; color:white; }
        .btn-primary:hover { background:#1d4ed8; }
        .btn-secondary { background:#111827; color:#e5e7eb; border:1px solid #374151; }
        .btn-secondary:hover { background:#020617; }
        .btn-success { background:#16a34a; color:white; }
        .btn-danger { background:#b91c1c; color:white; }
        .multimeter { background:#020617; border-radius:16px; padding:18px; border:1px solid #1f2937; display:grid; grid-template-columns:1.1fr 1.2fr; gap:15px; align-items:start; }

        .multimeter-screen { background:#0f172a; border-radius:12px; padding:12px; text-align:center; box-shadow: inset 0 0 15px rgba(0,0,0,0.8); }
        .multimeter-screen h3 { color:#22c55e; font-family:'Consolas',monospace; font-size:26px; }
        .multimeter-screen small { color:#9ca3af; font-size:11px; }
        .multimeter-controls { display:flex; flex-direction:column; gap:8px; }
        .row { display:flex; gap:8px; align-items:center; }
        select, input[type="number"] { padding:6px 8px; border-radius:8px; border:1px solid #374151; background:#020617; color:#e5e7eb; font-size:13px; }
        input[type="number"] { width:100px; }
        .unit-select { width:90px; }
        .measure-row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:8px; }
        .measure-row span.label { width:110px; color:#e5e7eb; }
        .feedback { margin-top:10px; padding:10px 12px; border-radius:10px; font-size:13px; }
        .feedback-ok { background:#022c22; color:#bbf7d0; border:1px solid #16a34a; }
        .feedback-bad { background:#3f1317; color:#fecaca; border:1px solid #b91c1c; }
        .log { max-height:230px; overflow-y:auto; font-size:12px; padding-right:5px; }
        .log-entry { border-bottom:1px dashed #1f2937; padding:6px 0; }
        .log-entry strong { color:#e5e7eb; }
        .conclusion { margin-top:10px; padding:10px 12px; border-radius:10px; background:#0b1120; border:1px solid #1f2937; }
        .tag { display:inline-block; padding:2px 6px; border-radius:999px; font-size:11px; margin-right:4px; }
        .tag-test { background:#1e3a8a; color:#e5e7eb; }
        .tag-ok { background:#166534; color:#bbf7d0; }
        .tag-ko { background:#7f1d1d; color:#fecaca; }
        @media (max-width:900px){ .content{flex-direction:column;} .left{border-right:none;border-bottom:1px solid #1f2937;} }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üîç Grille diagnostic + multim√®tre virtuel</h1>
                <p>Simulation de pannes E32 - BAC PRO MELEC (maintenance corrective)</p>
            </div>
            <button class="btn btn-secondary" onclick="resetScenario()">üîÑ R√©initialiser</button>
        </div>

        <div class="scenario-select">
            <div>
                <span style="font-size:13px;">Sc√©nario de panne :</span>
                <select id="scenarioSelect" onchange="loadScenario()">
                    <option value="prise">Prise 16A atelier ne fonctionne plus</option>
                    <option value="moteur">Moteur VMC ne d√©marre plus</option>
                    <option value="eclairage">√âclairage va-et-vient en panne</option>
                </select>
            </div>
            <div>
                <span class="badge badge-step">√âtape : <span id="stepLabel">1/4 - Sympt√¥mes</span></span>
            </div>
        </div>

        <div class="content">
            <div class="left">
                <h2>1. Sympt√¥mes & contexte</h2>
                <div class="card" id="symptomesCard"></div>

                <h2>2. Hypoth√®se de panne</h2>
                <div class="card" id="hypothesesCard"></div>

                <h2>3. Tests √† r√©aliser</h2>
                <div class="card" id="testsCard"></div>
            </div>

            <div class="right">
                <h2>4. Multim√®tre virtuel - saisie des mesures</h2>
                <div class="multimeter">
                    <div class="multimeter-screen">
                        <small>Mode s√©lectionn√©</small>
                        <h3 id="screenMode">---
                        </h3>
                        <small>Valeur mesur√©e</small>
                        <h3 id="screenValue">0.00</h3>
                    </div>
                    <div class="multimeter-controls">
                        <div class="row">
                            <label>Type de mesure :</label>
                            <select id="mesureType" onchange="updateMode()">
                                <option value="tension">Tension</option>
                                <option value="intensite">Intensit√©</option>
                                <option value="isolement">Isolation</option>
                                <option value="continuite">Continuit√©</option>
                            </select>
                        </div>
                        <div class="measure-row">
                            <span class="label">Valeur attendue :</span>
                            <input type="number" id="valAttendue" step="0.01" placeholder="ex: 230">
                            <select id="unitAttendue" class="unit-select">
                                <option value="V">V</option>
                                <option value="A">A</option>
                                <option value="kOhm">kŒ©</option>
                                <option value="MOhm">MŒ©</option>
                            </select>
                        </div>
                        <div class="measure-row">
                            <span class="label">Valeur mesur√©e :</span>
                            <input type="number" id="valMesuree" step="0.01" placeholder="ex: 0" oninput="updateScreen()">
                            <select id="unitMesuree" class="unit-select" onchange="updateScreen()">
                                <option value="V">V</option>
                                <option value="A">A</option>
                                <option value="kOhm">kŒ©</option>
                                <option value="MOhm">MŒ©</option>
                            </select>
                        </div>
                        <div class="measure-row">
                            <span class="label">Tol√©rance :</span>
                            <input type="number" id="tolerance" step="0.1" value="10">
                            <span>%</span>
                        </div>
                        <div class="row">
                            <button class="btn btn-primary" onclick="validerMesure()">‚úÖ Valider la mesure</button>
                        </div>
                        <div id="measureFeedback"></div>
                    </div>
                </div>

                <div class="card" style="margin-top:18px;">
                    <h2>Historique des tests</h2>
                    <div class="log" id="logTests"></div>
                    <div class="conclusion" id="conclusionBloc"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const scenarios = {
            prise: {
                symptomes: "La prise 16A de l'atelier ne fonctionne plus depuis ce matin. Les autres prises du circuit fonctionnent. Le disjoncteur divisionnaire est enclench√©.",
                hypotheses: [
                    { id: 'h1', text: 'Borne desserr√©e dans la prise', correct: true },
                    { id: 'h2', text: 'Disjoncteur g√©n√©ral d√©clench√©', correct: false },
                    { id: 'h3', text: 'Lampe grill√©e', correct: false }
                ],
                tests: [
                    { id: 't1', text: 'Mesurer la tension √† la prise (V)', mesureType: 'tension', attendu: 230, unite: 'V', scenarioValeur: 0 },
                    { id: 't2', text: 'Contr√¥ler la continuit√© des conducteurs vers la prise (Œ©)', mesureType: 'continuite', attendu: 0, unite: 'kOhm', scenarioValeur: 10 }
                ],
                conclusion: "La panne est due √† une borne desserr√©e dans la prise, provoquant une coupure du conducteur." 
            },
            moteur: {
                symptomes: "Le moteur de VMC ne d√©marre plus. Le disjoncteur est enclench√©. Une odeur suspecte a √©t√© ressentie la veille.",
                hypotheses: [
                    { id: 'h1', text: 'Condensateur permanent HS', correct: true },
                    { id: 'h2', text: 'Lampe grill√©e', correct: false },
                    { id: 'h3', text: 'Prise d√©branch√©e', correct: false }
                ],
                tests: [
                    { id: 't1', text: 'Mesurer la tension aux bornes moteur (V)', mesureType: 'tension', attendu: 230, unite: 'V', scenarioValeur: 230 },
                    { id: 't2', text: 'Mesurer la capacit√© ou l'√©tat du condensateur (kŒ© en isolement)', mesureType: 'isolement', attendu: 0.5, unite: 'MOhm', scenarioValeur: 0 }
                ],
                conclusion: "La panne est due au condensateur permanent d√©fectueux, emp√™chant le d√©marrage du moteur."
            },
            eclairage: {
                symptomes: "L'√©clairage d'un couloir command√© par va-et-vient ne fonctionne plus. Les lampes sont neuves.",
                hypotheses: [
                    { id: 'h1', text: 'Fil navette coup√© ou d√©branch√©', correct: true },
                    { id: 'h2', text: 'Disjoncteur g√©n√©ral d√©clench√©', correct: false },
                    { id: 'h3', text: 'Condensateur HS', correct: false }
                ],
                tests: [
                    { id: 't1', text: 'Mesurer la tension en sortie de disjoncteur (V)', mesureType: 'tension', attendu: 230, unite: 'V', scenarioValeur: 230 },
                    { id: 't2', text: 'Contr√¥ler la continuit√© du fil navette (Œ©)', mesureType: 'continuite', attendu: 0, unite: 'kOhm', scenarioValeur: 9999 }
                ],
                conclusion: "La panne est due √† une coupure du fil navette dans le circuit va-et-vient."
            }
        };

        let currentScenario = 'prise';
        let chosenHypothesis = null;
        let chosenTest = null;
        let step = 1;

        function loadScenario() {
            currentScenario = document.getElementById('scenarioSelect').value;
            chosenHypothesis = null;
            chosenTest = null;
            step = 1;
            document.getElementById('logTests').innerHTML = '';
            document.getElementById('conclusionBloc').innerHTML = '';
            document.getElementById('measureFeedback').innerHTML = '';
            document.getElementById('screenMode').textContent = '---';
            document.getElementById('screenValue').textContent = '0.00';
            updateStepLabel();
            renderSymptomes();
            renderHypotheses();
            renderTests();
        }

        function updateStepLabel(){
            const labels = {
                1:"1/4 - Sympt√¥mes",2:"2/4 - Hypoth√®se",3:"3/4 - Tests",4:"4/4 - Conclusion"};
            document.getElementById('stepLabel').textContent = labels[step];
        }

        function renderSymptomes(){
            const sc = scenarios[currentScenario];
            document.getElementById('symptomesCard').innerHTML = `
                <span class="badge badge-sympt">SYMPT√îMES</span>
                <p style="margin-top:8px;">${sc.symptomes}</p>
            `;
        }

        function renderHypotheses(){
            const sc = scenarios[currentScenario];
            let html = '<p>Choisir l'hypoth√®se la plus probable :</p><div style="margin-top:8px;">';
            sc.hypotheses.forEach(h => {
                html += `<button class="btn btn-secondary" onclick="selectHypothesis('${h.id}')">${h.text}</button><br>`;
            });
            html += '</div>';
            document.getElementById('hypothesesCard').innerHTML = html;
        }

        function renderTests(){
            const sc = scenarios[currentScenario];
            let html = '<p>Choisir le test √† effectuer avec le multim√®tre :</p><div style="margin-top:8px;">';
            sc.tests.forEach(t => {
                html += `<button class="btn btn-secondary" onclick="selectTest('${t.id}')">${t.text}</button><br>`;
            });
            html += '</div>';
            document.getElementById('testsCard').innerHTML = html;
        }

        function selectHypothesis(id){
            chosenHypothesis = id;
            step = 3; // on autorise tests apr√®s choix d'hypoth√®se
            updateStepLabel();
        }

        function selectTest(id){
            chosenTest = id;
            step = 3;
            updateStepLabel();
            const sc = scenarios[currentScenario];
            const test = sc.tests.find(t=>t.id===id);
            document.getElementById('mesureType').value = test.mesureType;
            updateMode();
            document.getElementById('valAttendue').value = test.attendu;
            document.getElementById('unitAttendue').value = test.unite;
        }

        function updateMode(){
            const type = document.getElementById('mesureType').value;
            const labels = {tension:'Tension',intensite:'Intensit√©',isolement:'Isolation',continuite:'Continuit√©'};
            document.getElementById('screenMode').textContent = labels[type] || '---';
        }

        function updateScreen(){
            const val = document.getElementById('valMesuree').value || 0;
            const unit = document.getElementById('unitMesuree').value;
            document.getElementById('screenValue').textContent = parseFloat(val).toFixed(2) + ' ' + unit;
        }

        function validerMesure(){
            if(!chosenHypothesis || !chosenTest){
                document.getElementById('measureFeedback').innerHTML = '<div class="feedback feedback-bad">‚ö†Ô∏è Choisir d'abord une hypoth√®se et un test.</div>';
                return;
            }
            const sc = scenarios[currentScenario];
            const test = sc.tests.find(t=>t.id===chosenTest);
            const valAtt = parseFloat(document.getElementById('valAttendue').value || 0);
            const valMes = parseFloat(document.getElementById('valMesuree').value || 0);
            const tol = parseFloat(document.getElementById('tolerance').value || 0);
            const unitA = document.getElementById('unitAttendue').value;
            const unitM = document.getElementById('unitMesuree').value;

            let conforme = false;
            if(unitA === unitM){
                const min = valAtt*(1 - tol/100);
                const max = valAtt*(1 + tol/100);
                conforme = (valMes >= min && valMes <= max);
            }

            const fb = document.getElementById('measureFeedback');
            if(conforme){
                fb.innerHTML = '<div class="feedback feedback-ok">‚úÖ Mesure coh√©rente avec la valeur attendue.</div>';
            } else {
                fb.innerHTML = '<div class="feedback feedback-bad">‚ö†Ô∏è Mesure non conforme ou unit√© diff√©rente. √Ä analyser.</div>';
            }

            // Ajout au log
            const log = document.getElementById('logTests');
            const hyp = sc.hypotheses.find(h=>h.id===chosenHypothesis);
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <div><span class="tag tag-test">TEST</span> <strong>${test.text}</strong></div>
                <div>Valeur attendue : ${valAtt} ${unitA} | Mesur√©e : ${valMes} ${unitM}</div>
                <div>Hypoth√®se : ${hyp.text}</div>
            `;
            log.appendChild(entry);

            step = 4;
            updateStepLabel();
            renderConclusion(conforme);
        }

        function renderConclusion(conforme){
            const sc = scenarios[currentScenario];
            const hyp = sc.hypotheses.find(h=>h.id===chosenHypothesis);
            const bloc = document.getElementById('conclusionBloc');
            let html = '<h3 style="color:#e5e7eb;font-size:15px;margin-bottom:8px;">üéØ Conclusion simul√©e</h3>';
            html += `<p>Hypoth√®se choisie : <strong>${hyp.text}</strong></p>`;
            if(hyp.correct){
                html += `<p><span class="tag tag-ok">BONNE PISTE</span> Cette hypoth√®se est coh√©rente avec les sympt√¥mes.</p>`;
            } else {
                html += `<p><span class="tag tag-ko">PISTE FAIBLE</span> Cette hypoth√®se est peu probable selon les sympt√¥mes.</p>`;
            }
            html += `<p style="margin-top:8px;">${sc.conclusion}</p>`;
            bloc.innerHTML = html;
        }

        function resetScenario(){
            document.getElementById('scenarioSelect').value = currentScenario;
            loadScenario();
        }

        // Initialisation
        loadScenario();
    </script>
</body>
</html>
