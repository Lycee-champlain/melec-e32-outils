<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Diagnostic + Multim√®tre virtuel - E32 MELEC</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Segoe UI,Tahoma,sans-serif;background:linear-gradient(135deg,#0f172a,#1e293b);color:#e5e7eb;padding:18px;min-height:100vh}
    .container{max-width:1180px;margin:0 auto;background:#0b1120;border:1px solid #1f293b;border-radius:18px;overflow:hidden;box-shadow:0 18px 40px rgba(0,0,0,.5)}
    header{background:linear-gradient(135deg,#1d4ed8,#22c55e);padding:18px 22px;color:white;display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    header h1{font-size:20px}
    header p{opacity:.92;font-size:13px;margin-top:4px}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;background:#020617;padding:12px 16px;border-bottom:1px solid #1f293b}
    .badge{background:#059669;color:white;font-weight:700;font-size:12px;padding:6px 10px;border-radius:999px}
    select,input{background:#020617;color:#e5e7eb;border:1px solid #374151;border-radius:10px;padding:10px 12px;font-size:14px}
    select{min-width:280px}
    .grid{display:flex;flex-wrap:wrap}
    .col{flex:1 1 420px;padding:18px}
    .col.right{background:#020617;border-left:1px solid #1f293b}
    @media (max-width: 980px){.col.right{border-left:none;border-top:1px solid #1f293b}}
    .card{background:#020617;border:1px solid #1f293b;border-radius:14px;padding:16px;margin-bottom:14px}
    .card h2{font-size:16px;margin-bottom:10px}
    .pill{display:inline-block;background:#1e40af;color:white;font-size:11px;font-weight:700;padding:6px 10px;border-radius:999px;margin-bottom:10px}
    .btn{border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;font-size:14px}
    .btn.primary{background:#2563eb;color:white}
    .btn.primary:hover{background:#1d4ed8}
    .btn.ghost{background:transparent;color:#e5e7eb;border:2px solid #4b5563}
    .btn.ghost:hover{background:#111827}
    .btn.block{width:100%;text-align:left;margin:6px 0}
    .muted{color:#9ca3af;font-size:13px;line-height:1.45}
    .ok{background:rgba(22,163,74,.18);border:1px solid #16a34a;color:#bbf7d0;padding:10px 12px;border-radius:12px}
    .ko{background:rgba(185,28,28,.18);border:1px solid #b91c1c;color:#fecaca;padding:10px 12px;border-radius:12px}
    .warning{background:rgba(245,158,11,.16);border:1px solid #f59e0b;color:#fde68a;padding:10px 12px;border-radius:12px}
    .meter{background:#0f172a;border:2px solid #1f293b;border-radius:16px;padding:14px}
    .screen{background:#111827;border-radius:14px;padding:14px;text-align:center;box-shadow:inset 0 0 18px rgba(0,0,0,.45)}
    .mode{font-family:Consolas,monospace;color:#22c55e;font-size:22px;margin:6px 0}
    .value{font-family:Consolas,monospace;color:#facc15;font-size:30px;font-weight:900}
    .formrow{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
    .formrow label{min-width:160px;color:#9ca3af;font-size:13px;font-weight:700}
    .formrow input[type="number"]{width:120px}
    .formrow select{min-width:120px}
    .mini{font-size:12px;color:#9ca3af;margin-top:8px}
    .log{max-height:240px;overflow:auto;border:1px solid #1f293b;border-radius:14px;padding:10px;background:#0b1120}
    .entry{padding:10px 0;border-bottom:1px dashed #1f293b}
    .entry:last-child{border-bottom:none}
    .entry strong{color:#e5e7eb}
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div>
        <h1>üîç Diagnostic + Multim√®tre virtuel</h1>
        <p>E32 ‚Äì Simulation de pannes (d√©marche : sympt√¥mes ‚Üí hypoth√®se ‚Üí tests ‚Üí conclusion)</p>
      </div>
      <button id="btnReset" class="btn ghost">üîÑ Nouvelle panne</button>
    </header>

    <div class="topbar">
      <div>
        <label for="scenarioSelect" class="muted" style="margin-right:10px;font-weight:800;">Sc√©nario :</label>
        <select id="scenarioSelect">
          <option value="prise">Prise 16A atelier HS</option>
          <option value="moteur">Moteur VMC ne d√©marre pas</option>
          <option value="eclairage">Va-et-vient √©clairage HS</option>
        </select>
      </div>
      <div class="badge">√âtape : <span id="stepLabel">1/4 - Sympt√¥mes</span></div>
    </div>

    <div class="grid">
      <div class="col left">
        <div class="card">
          <h2>1) Sympt√¥mes & contexte</h2>
          <div id="symptomesCard"></div>
        </div>

        <div class="card">
          <h2>2) Choix d‚Äôhypoth√®se</h2>
          <div id="hypothesesCard"></div>
        </div>

        <div class="card">
          <h2>3) Choix du test</h2>
          <div id="testsCard"></div>
        </div>
      </div>

      <div class="col right">
        <div class="card">
          <h2>4) Multim√®tre virtuel</h2>

          <div class="meter">
            <div class="screen">
              <div class="mini">Mode</div>
              <div class="mode" id="screenMode">‚Äî</div>
              <div class="mini" style="margin-top:8px;">Valeur mesur√©e</div>
              <div class="value" id="screenValue">0.00</div>
              <div class="mini">Saisie manuelle (ou bouton ‚ÄúMesure simul√©e‚Äù)</div>
            </div>

            <div class="formrow">
              <label for="mesureType">Type de mesure</label>
              <select id="mesureType">
                <option value="">‚Äî</option>
                <option value="tension">Tension</option>
                <option value="intensite">Intensit√©</option>
                <option value="continuite">Continuit√©</option>
                <option value="isolement">Isolement</option>
              </select>
            </div>

            <div class="formrow">
              <label>Valeur attendue</label>
              <input id="valAttendue" type="number" step="0.01" min="0" placeholder="ex: 230" />
              <select id="unitAttendue">
                <option>V</option>
                <option>A</option>
                <option>Œ©</option>
                <option>kŒ©</option>
                <option>MŒ©</option>
              </select>
            </div>

            <div class="formrow">
              <label>Valeur mesur√©e</label>
              <input id="valMesuree" type="number" step="0.01" min="0" placeholder="ex: 0" />
              <select id="unitMesuree">
                <option>V</option>
                <option>A</option>
                <option>Œ©</option>
                <option>kŒ©</option>
                <option>MŒ©</option>
              </select>
              <button id="btnSimu" class="btn ghost" type="button">üéõÔ∏è Mesure simul√©e</button>
            </div>

            <div class="formrow">
              <label for="tolerance">Tol√©rance</label>
              <input id="tolerance" type="number" step="1" min="0" max="50" value="5" />
              <span class="muted">%</span>
              <button id="btnValidate" class="btn primary" type="button">‚úÖ Valider</button>
            </div>

            <div id="measureFeedback" style="margin-top:10px;"></div>
          </div>
        </div>

        <div class="card">
          <h2>Historique</h2>
          <div class="log" id="logTests"></div>
        </div>

        <div class="card" id="conclusionBloc" style="display:none;">
          <h2>Conclusion simul√©e</h2>
          <div id="conclusionInner"></div>
        </div>
      </div>
    </div>
  </div>

<script>
(function () {
  // --- Donn√©es sc√©narios (mesures simul√©es pour "Mesure simul√©e") ---
  const scenarios = {
    prise: {
      symptomes: "Prise 16A atelier : ne fonctionne plus. Autres prises du circuit OK. DJ divisionnaire enclench√©.",
      hypotheses: [
        { id: "h1", text: "Borne desserr√©e dans la prise", correct: true },
        { id: "h2", text: "Disjoncteur g√©n√©ral HS", correct: false },
        { id: "h3", text: "C√¢ble principal coup√©", correct: false }
      ],
      tests: [
        { id: "t1", text: "Mesurer la tension aux bornes de la prise", type: "tension", attendu: 230, unit: "V", simu: 0, simuUnit: "V" },
        { id: "t2", text: "Contr√¥ler la continuit√© (conducteur phase vers prise)", type: "continuite", attendu: 0.10, unit: "Œ©", simu: 15, simuUnit: "Œ©" },
        { id: "t3", text: "Mesurer l‚Äôisolement (prise / terre)", type: "isolement", attendu: 1.00, unit: "MŒ©", simu: 0.80, simuUnit: "MŒ©" }
      ],
      conclusion: "Cause : borne desserr√©e. Action : resserrer, contr√¥ler et remettre en service."
    },

    moteur: {
      symptomes: "VMC : moteur ne d√©marre plus. Disjoncteur enclench√©. Odeur suspecte signal√©e la veille.",
      hypotheses: [
        { id: "h1", text: "Condensateur permanent HS", correct: true },
        { id: "h2", text: "Protection thermique d√©clench√©e", correct: false },
        { id: "h3", text: "Moteur grill√©", correct: false }
      ],
      tests: [
        { id: "t1", text: "Mesurer la tension d‚Äôalimentation au moteur", type: "tension", attendu: 230, unit: "V", simu: 230, simuUnit: "V" },
        { id: "t2", text: "Mesurer l‚Äôisolement des enroulements", type: "isolement", attendu: 1.00, unit: "MŒ©", simu: 0.30, simuUnit: "MŒ©" },
        { id: "t3", text: "Contr√¥ler la continuit√© / √©tat du condensateur (test indirect)", type: "continuite", attendu: 0.10, unit: "Œ©", simu: 999, simuUnit: "Œ©" }
      ],
      conclusion: "Cause : condensateur HS. Action : remplacer (m√™me valeur), essai fonctionnel."
    },

    eclairage: {
      symptomes: "Couloir : va-et-vient ne commande plus l‚Äô√©clairage. Lampes neuves. Disjoncteur OK.",
      hypotheses: [
        { id: "h1", text: "Fil navette coup√© / d√©branch√©", correct: true },
        { id: "h2", text: "Interrupteur HS", correct: false },
        { id: "h3", text: "Phase coup√©e", correct: false }
      ],
      tests: [
        { id: "t1", text: "Mesurer la tension en sortie de disjoncteur √©clairage", type: "tension", attendu: 230, unit: "V", simu: 230, simuUnit: "V" },
        { id: "t2", text: "Contr√¥ler la continuit√© du fil navette", type: "continuite", attendu: 0.10, unit: "Œ©", simu: 9999, simuUnit: "Œ©" },
        { id: "t3", text: "Contr√¥ler la continuit√© d‚Äôun interrupteur", type: "continuite", attendu: 0.10, unit: "Œ©", simu: 0.05, simuUnit: "Œ©" }
      ],
      conclusion: "Cause : navette coup√©e. Action : localiser, r√©parer, test de fonctionnement."
    }
  };

  // --- √âl√©ments DOM ---
  const elScenario = document.getElementById("scenarioSelect");
  const elStep = document.getElementById("stepLabel");
  const elSympt = document.getElementById("symptomesCard");
  const elHyp = document.getElementById("hypothesesCard");
  const elTests = document.getElementById("testsCard");

  const elType = document.getElementById("mesureType");
  const elVA = document.getElementById("valAttendue");
  const elUA = document.getElementById("unitAttendue");
  const elVM = document.getElementById("valMesuree");
  const elUM = document.getElementById("unitMesuree");
  const elTol = document.getElementById("tolerance");

  const elScreenMode = document.getElementById("screenMode");
  const elScreenValue = document.getElementById("screenValue");
  const elFeedback = document.getElementById("measureFeedback");
  const elLog = document.getElementById("logTests");
  const elConclusion = document.getElementById("conclusionBloc");
  const elConclusionInner = document.getElementById("conclusionInner");

  const btnReset = document.getElementById("btnReset");
  const btnValidate = document.getElementById("btnValidate");
  const btnSimu = document.getElementById("btnSimu");

  // --- √âtat ---
  let currentKey = elScenario.value;
  let chosenHypId = null;
  let chosenTestId = null;
  let history = [];

  // --- Utilitaires ---
  function setStep(text) { elStep.textContent = text; }

  function unitFactor(u) {
    if (u === "Œ©") return 1;
    if (u === "kŒ©") return 1000;
    if (u === "MŒ©") return 1000000;
    return 1;
  }

  function isUnitCompatible(measureType, unit) {
    if (measureType === "tension") return unit === "V";
    if (measureType === "intensite") return unit === "A";
    if (measureType === "continuite" || measureType === "isolement") return (unit === "Œ©" || unit === "kŒ©" || unit === "MŒ©");
    return true;
  }

  function updateScreen() {
    const v = parseFloat(elVM.value);
    const val = Number.isFinite(v) ? v : 0;
    elScreenValue.textContent = val.toFixed(2) + " " + elUM.value;
  }

  function updateMode() {
    const map = { tension: "Tension", intensite: "Intensit√©", continuite: "Continuit√©", isolement: "Isolement" };
    elScreenMode.textContent = map[elType.value] || "‚Äî";
  }

  function getScenario() { return scenarios[currentKey]; }
  function getSelectedTest() {
    const sc = getScenario();
    return sc.tests.find(t => t.id === chosenTestId) || null;
  }
  function getSelectedHyp() {
    const sc = getScenario();
    return sc.hypotheses.find(h => h.id === chosenHypId) || null;
  }

  function renderSymptomes() {
    const sc = getScenario();
    elSympt.innerHTML = '<span class="pill">SYMPT√îMES</span><div class="muted">' + sc.symptomes + "</div>";
  }

  function renderHypotheses() {
    const sc = getScenario();
    elHyp.innerHTML = "";
    const p = document.createElement("div");
    p.className = "muted";
    p.textContent = "Choisis l'hypoth√®se la plus probable :";
    elHyp.appendChild(p);

    sc.hypotheses.forEach(h => {
      const b = document.createElement("button");
      b.type = "button";
      b.className = "btn ghost block";
      b.textContent = h.text;
      b.addEventListener("click", () => {
        chosenHypId = h.id;
        chosenTestId = null;
        setStep("3/4 - Test");
        renderHypothesesSelected();
        renderTests();
        elFeedback.innerHTML = "";
        elConclusion.style.display = "none";
      });
      elHyp.appendChild(b);
    });

    renderHypothesesSelected();
  }

  function renderHypothesesSelected() {
    const h = getSelectedHyp();
    if (!h) return;

    const box = document.createElement("div");
    box.style.marginTop = "10px";
    box.innerHTML =
      (h.correct ? '<div class="ok"><strong>Hypoth√®se retenue :</strong> ' : '<div class="warning"><strong>Hypoth√®se retenue :</strong> ') +
      h.text + "</div>";

    // Nettoie l'ancien r√©sum√© si pr√©sent
    const old = elHyp.querySelector("[data-selected='1']");
    if (old) old.remove();
    box.setAttribute("data-selected", "1");
    elHyp.appendChild(box);
  }

  function renderTests() {
    const sc = getScenario();
    elTests.innerHTML = "";

    const info = document.createElement("div");
    info.className = "muted";
    info.textContent = chosenHypId ? "Choisis un test √† r√©aliser au multim√®tre :" : "Choisis d'abord une hypoth√®se pour d√©bloquer les tests.";
    elTests.appendChild(info);

    sc.tests.forEach(t => {
      const b = document.createElement("button");
      b.type = "button";
      b.className = "btn ghost block";
      b.textContent = t.text;
      b.disabled = !chosenHypId;
      b.style.opacity = chosenHypId ? "1" : "0.5";
      b.addEventListener("click", () => {
        chosenTestId = t.id;
        setStep("4/4 - Mesure");
        // Pr√©-remplissage
        elType.value = t.type;
        updateMode();
        elVA.value = String(t.attendu);
        elUA.value = t.unit;
        // Astuce : met une unit√© compatible par d√©faut c√¥t√© mesur√©
        elUM.value = t.unit;
        elFeedback.innerHTML = "";
        elConclusion.style.display = "none";
      });
      elTests.appendChild(b);
    });

    if (chosenTestId) {
      const t = getSelectedTest();
      const box = document.createElement("div");
      box.style.marginTop = "10px";
      box.innerHTML = '<div class="warning"><strong>Test s√©lectionn√© :</strong> ' + t.text + "</div>";
      elTests.appendChild(box);
    }
  }

  function renderLog() {
    if (!history.length) {
      elLog.innerHTML = '<div class="muted" style="font-style:italic">Aucun test effectu√©.</div>';
      return;
    }
    elLog.innerHTML = "";
    history.slice().reverse().forEach(item => {
      const div = document.createElement("div");
      div.className = "entry";
      div.innerHTML =
        "<strong>" + item.test + "</strong><br>" +
        "Attendue : " + item.attendu + " | Mesur√©e : " + item.mesuree + "<br>" +
        (item.ok ? '<span style="color:#bbf7d0;font-weight:800">‚úÖ OK</span>' : '<span style="color:#fecaca;font-weight:800">‚ö†Ô∏è √Ä analyser</span>');
      elLog.appendChild(div);
    });
  }

  function showConclusion() {
    const sc = getScenario();
    const h = getSelectedHyp();
    if (!h) return;

    elConclusionInner.innerHTML =
      (h.correct ? '<div class="ok"><strong>Hypoth√®se pertinente :</strong> ' : '<div class="warning"><strong>Hypoth√®se moins probable :</strong> ') +
      h.text + "</div>" +
      '<div style="margin-top:10px" class="muted"><strong>Cause r√©elle simul√©e :</strong> ' + sc.conclusion + "</div>";

    elConclusion.style.display = "block";
  }

  function validateMeasure() {
    const t = getSelectedTest();
    const h = getSelectedHyp();
    if (!h || !t) {
      elFeedback.innerHTML = '<div class="ko">‚ö†Ô∏è S√©lectionne d‚Äôabord une hypoth√®se puis un test.</div>';
      return;
    }

    const type = elType.value;
    const a = parseFloat(elVA.value);
    const m = parseFloat(elVM.value);
    const tol = parseFloat(elTol.value);

    if (!type) { elFeedback.innerHTML = '<div class="ko">‚ö†Ô∏è Choisis le type de mesure.</div>'; return; }
    if (!Number.isFinite(a) || !Number.isFinite(m)) { elFeedback.innerHTML = '<div class="ko">‚ö†Ô∏è Renseigne valeur attendue et valeur mesur√©e.</div>'; return; }
    if (!Number.isFinite(tol)) { elFeedback.innerHTML = '<div class="ko">‚ö†Ô∏è Tol√©rance invalide.</div>'; return; }

    // Compatibilit√© unit√©s / type
    const ua = elUA.value;
    const um = elUM.value;
    if (!isUnitCompatible(type, ua) || !isUnitCompatible(type, um)) {
      elFeedback.innerHTML = '<div class="ko">‚ö†Ô∏è Unit√© incoh√©rente avec le type de mesure.</div>';
      return;
    }

    // Conversion (Œ©, kŒ©, MŒ©) si mesure de r√©sistance/isolement
    let aBase = a, mBase = m;
    if (type === "continuite" || type === "isolement") {
      aBase = a * unitFactor(ua);
      mBase = m * unitFactor(um);
    } else {
      // tension/intensit√© : on impose m√™me unit√©
      if (ua !== um) {
        elFeedback.innerHTML = '<div class="ko">‚ö†Ô∏è Pour la tension / intensit√©, mets la m√™me unit√© (V ou A).</div>';
        return;
      }
    }

    // Tol√©rance : si attendu = 0, on accepte un √©cart absolu faible
    let ok = false;
    if (aBase === 0) ok = Math.abs(mBase) <= 0.01;
    else ok = Math.abs(mBase - aBase) <= (Math.abs(aBase) * tol / 100);

    elFeedback.innerHTML = ok ? '<div class="ok">‚úÖ Mesure coh√©rente (dans la tol√©rance).</div>'
                              : '<div class="ko">‚ö†Ô∏è Mesure hors tol√©rance : √† interpr√©ter dans le diagnostic.</div>';

    // Historique
    history.push({
      test: t.text,
      attendu: a + " " + ua,
      mesuree: m + " " + um,
      ok: ok
    });
    renderLog();
    showConclusion();
  }

  function simulateMeasure() {
    const t = getSelectedTest();
    if (!t) {
      elFeedback.innerHTML = '<div class="ko">‚ö†Ô∏è S√©lectionne un test, puis clique ‚ÄúMesure simul√©e‚Äù.</div>';
      return;
    }
    elVM.value = String(t.simu);
    elUM.value = t.simuUnit;
    updateScreen();
    elFeedback.innerHTML = '<div class="warning">üéõÔ∏è Mesure simul√©e appliqu√©e. Tu peux maintenant valider.</div>';
  }

  function resetAll() {
    chosenHypId = null;
    chosenTestId = null;
    history = [];
    elType.value = "";
    elVA.value = "";
    elVM.value = "";
    elUA.value = "V";
    elUM.value = "V";
    elTol.value = "5";
    elFeedback.innerHTML = "";
    elScreenMode.textContent = "‚Äî";
    elScreenValue.textContent = "0.00";
    elConclusion.style.display = "none";
    renderSymptomes();
    renderHypotheses();
    renderTests();
    renderLog();
    setStep("1/4 - Sympt√¥mes");
  }

  function resetDiagnostic() {
    // reset ‚Äúsoft‚Äù quand on change de sc√©nario
    chosenHypId = null;
    chosenTestId = null;
    history = [];
    elFeedback.innerHTML = "";
    elConclusion.style.display = "none";
    elType.value = "";
    elVA.value = "";
    elVM.value = "";
    elTol.value = "5";
    elScreenMode.textContent = "‚Äî";
    elScreenValue.textContent = "0.00";
    renderLog();
    setStep("1/4 - Sympt√¥mes");
  }

  // --- Listeners ---
  elScenario.addEventListener("change", () => {
    currentKey = elScenario.value;
    resetDiagnostic();
    renderSymptomes();
    renderHypotheses();
    renderTests();
  });

  elType.addEventListener("change", () => { updateMode(); });
  elVM.addEventListener("input", () => { updateScreen(); });
  elUM.addEventListener("change", () => { updateScreen(); });

  btnValidate.addEventListener("click", validateMeasure);
  btnSimu.addEventListener("click", simulateMeasure);
  btnReset.addEventListener("click", () => {
    // garde le sc√©nario, relance une nouvelle "panne" (reset complet)
    resetAll();
  });

  // --- Init ---
  currentKey = elScenario.value;
  resetAll();
})();
</script>
</body>
</html>
