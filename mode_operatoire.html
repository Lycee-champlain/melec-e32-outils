<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mode Op√©ratoire Maintenance - E32 MELEC</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; color: #333; }
        .header { text-align: center; margin-bottom: 30px; padding: 20px; background: white; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header h1 { color: #2c3e50; font-size: 24px; margin-bottom: 10px; }
        .progress-container { position: sticky; top: 0; background: white; z-index: 100; padding: 15px; border-radius: 0 0 15px 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .progress-bar { height: 10px; background: #e9ecef; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; background: #22c55e; width: 0%; transition: width 0.5s ease; }
        .step { background: white; margin-bottom: 25px; padding: 25px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: all 0.3s ease; opacity: 0.6; pointer-events: none; border-left: 5px solid #bdc3c7; }
        .step.active { opacity: 1; pointer-events: all; border-left-color: #3498db; transform: scale(1.02); }
        .step.completed { opacity: 0.8; border-left-color: #2ecc71; background: #f0fff4; }
        .step-header { display: flex; align-items: center; margin-bottom: 20px; }
        .step-number { background: #3498db; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; }
        .step.completed .step-number { background: #2ecc71; }
        h2 { font-size: 20px; color: #2c3e50; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.2s; margin-top: 10px; }
        .btn-primary { background: #3498db; color: white; }
        .btn-success { background: #2ecc71; color: white; width: 100%; margin-top: 20px; padding: 15px; font-size: 16px; }
        .btn-success:hover { background: #27ae60; }
        .btn-danger { background: #e74c3c; color: white; }
        input[type="text"], textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-top: 10px; font-family: inherit; }
        .checklist-item { display: flex; align-items: center; margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; }
        .checklist-item input { transform: scale(1.5); margin-right: 15px; }
        .timer { font-family: 'Consolas', monospace; font-size: 18px; color: #e67e22; margin-left: auto; background: #fff3e0; padding: 5px 10px; border-radius: 5px; }
        .hypo-list { margin: 15px 0; }
        .hypo-item { display: flex; gap: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="progress-container">
    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
        <span id="progressText">Pr√©paration</span>
        <span id="totalTimer" style="font-weight:bold; color:#2c3e50;">00:00</span>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
</div>

<div class="header">
    <h1>üìù Mode Op√©ratoire E32</h1>
    <p>Maintenance Corrective - Suivi d'intervention</p>
</div>

<!-- √âTAPE 0 : PR√âPARATION -->
<div class="step active" id="step0">
    <div class="step-header">
        <span class="step-number">0</span>
        <h2>Pr√©paration de l'intervention</h2>
    </div>
    <div>
        <label>Nom de l'√©l√®ve :</label>
        <input type="text" id="eleveNom" placeholder="Votre nom...">
        <label style="margin-top:10px; display:block;">Syst√®me / Support :</label>
        <input type="text" id="systemeNom" placeholder="Ex: Malaxeur, TGBT...">
    </div>
    <button class="btn btn-success" onclick="validateStep0()">D√©marrer l'intervention ‚ñ∂</button>
</div>

<!-- √âTAPE 1 : S√âCURIT√â -->
<div class="step" id="step1">
    <div class="step-header">
        <span class="step-number">1</span>
        <h2>Mise en s√©curit√© (Consignation)</h2>
        <div class="timer" id="timer1">00:00</div>
    </div>
    <div class="checklist-item">
        <input type="checkbox" id="secu1" onchange="checkSecu()">
        <label>Autorisation d'acc√®s / Bon de travail sign√©</label>
    </div>
    <div class="checklist-item">
        <input type="checkbox" id="secu2" onchange="checkSecu()">
        <label>EPI port√©s (Gants, √âcran facial, Tapis)</label>
    </div>
    <div class="checklist-item">
        <input type="checkbox" id="secu3" onchange="checkSecu()">
        <label>VAT effectu√©e (V√©rification Absence Tension)</label>
    </div>
    <div id="btnSecuContainer"></div>
</div>

<!-- √âTAPE 2 : ANALYSE -->
<div class="step" id="step2">
    <div class="step-header">
        <span class="step-number">2</span>
        <h2>Analyse du dysfonctionnement</h2>
        <div class="timer" id="timer2">00:00</div>
    </div>
    <p>D√©crivez les sympt√¥mes observ√©s et votre analyse :</p>
    <textarea id="analyseText" rows="4" placeholder="Le moteur grogne mais ne tourne pas..."></textarea>
    <button class="btn btn-success" onclick="validateStep2()">‚úÖ Valider l'analyse et continuer</button>
</div>

<!-- √âTAPE 3 : HYPOTH√àSES -->
<div class="step" id="step3">
    <div class="step-header">
        <span class="step-number">3</span>
        <h2>Hypoth√®ses de pannes</h2>
        <div class="timer" id="timer3">00:00</div>
    </div>
    <div class="hypo-list" id="hypoContainer">
        <div class="hypo-item">
            <input type="text" placeholder="Hypoth√®se 1 (ex: Fusible HS)">
        </div>
    </div>
    <button class="btn btn-primary" onclick="addHypo()">+ Ajouter une hypoth√®se</button>
    <button class="btn btn-success" onclick="validateStep3()">‚úÖ Valider les hypoth√®ses</button>
</div>

<!-- √âTAPE 4 : MESURES -->
<div class="step" id="step4">
    <div class="step-header">
        <span class="step-number">4</span>
        <h2>Mesures et Tests</h2>
        <div class="timer" id="timer4">00:00</div>
    </div>
    <p>Notez vos mesures significatives :</p>
    <div class="hypo-list" id="mesuresContainer">
        <div class="hypo-item">
            <input type="text" placeholder="Test effectu√© (ex: Tension U1-U2)">
            <input type="text" placeholder="Valeur (ex: 230V)" style="width:100px;">
        </div>
    </div>
    <button class="btn btn-primary" onclick="addMesure()">+ Ajouter une mesure</button>
    <button class="btn btn-success" onclick="validateStep4()">‚úÖ Valider les mesures</button>
</div>

<!-- √âTAPE 5 : REMISE EN SERVICE -->
<div class="step" id="step5">
    <div class="step-header">
        <span class="step-number">5</span>
        <h2>Remise en service</h2>
        <div class="timer" id="timer5">00:00</div>
    </div>
    <div class="checklist-item">
        <input type="checkbox" id="remise1">
        <label>Outils retir√©s de la zone</label>
    </div>
    <div class="checklist-item">
        <input type="checkbox" id="remise2">
        <label>Protections remises en place</label>
    </div>
    <div class="checklist-item">
        <input type="checkbox" id="remise3">
        <label>Essai de fonctionnement OK</label>
    </div>
    <button class="btn btn-success" onclick="validateStep5()">üèÅ Terminer l'intervention</button>
</div>

<!-- √âTAPE 6 : RAPPORT -->
<div class="step" id="step6">
    <div class="step-header">
        <span class="step-number">6</span>
        <h2>Rapport d'intervention</h2>
    </div>
    <div style="background:#d4edda; color:#155724; padding:20px; border-radius:10px; text-align:center;">
        <h3>üéâ Intervention termin√©e !</h3>
        <p>Temps total : <span id="finalTime"></span></p>
    </div>
    <button class="btn btn-primary" style="width:100%; margin-top:20px;" onclick="generatePDF()">üìÑ T√©l√©charger le rapport PDF</button>
</div>

<script>
    let currentStep = 0;
    let startTime = Date.now();
    let stepTimers = {};

    // Timer global
    setInterval(() => {
        const totalSeconds = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById('totalTimer').textContent = formatTime(totalSeconds);
        
        // Timer de l'√©tape active
        if(currentStep > 0 && currentStep < 6) {
            const el = document.getElementById('timer' + currentStep);
            if(el) {
                if(!stepTimers[currentStep]) stepTimers[currentStep] = Date.now();
                const stepSeconds = Math.floor((Date.now() - stepTimers[currentStep]) / 1000);
                el.textContent = formatTime(stepSeconds);
            }
        }
    }, 1000);

    function formatTime(s) {
        const m = Math.floor(s / 60);
        const sec = s % 60;
        return `${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
    }

    function goToStep(n) {
        // Marquer l'√©tape actuelle comme termin√©e
        const currentEl = document.getElementById('step' + currentStep);
        if(currentEl) {
            currentEl.classList.remove('active');
            currentEl.classList.add('completed');
        }

        // Activer la nouvelle √©tape
        currentStep = n;
        const nextEl = document.getElementById('step' + n);
        if(nextEl) {
            nextEl.classList.add('active');
            nextEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Init timer √©tape
            stepTimers[n] = Date.now();
        }

        // Barre de progression
        const pct = (n / 6) * 100;
        document.getElementById('progressFill').style.width = pct + '%';
        document.getElementById('progressText').textContent = `√âtape ${n} / 6`;
    }

    // --- VALIDATIONS ---

    function validateStep0() {
        if(document.getElementById('eleveNom').value.length < 2) {
            alert("Merci d'indiquer votre nom.");
            return;
        }
        startTime = Date.now(); // Reset timer
        goToStep(1);
    }

    function checkSecu() {
        const s1 = document.getElementById('secu1').checked;
        const s2 = document.getElementById('secu2').checked;
        const s3 = document.getElementById('secu3').checked;
        
        const container = document.getElementById('btnSecuContainer');
        if(s1 && s2 && s3) {
            container.innerHTML = '<button class="btn btn-success" onclick="goToStep(2)">‚úÖ S√©curit√© OK - Continuer</button>';
        } else {
            container.innerHTML = '';
        }
    }

    function validateStep2() {
        const txt = document.getElementById('analyseText').value;
        if(txt.length < 5) {
            alert("D√©crivez votre analyse (min 5 caract√®res).");
            return;
        }
        goToStep(3);
    }

    function addHypo() {
        const div = document.createElement('div');
        div.className = 'hypo-item';
        div.innerHTML = '<input type="text" placeholder="Nouvelle hypoth√®se...">';
        document.getElementById('hypoContainer').appendChild(div);
    }

    function validateStep3() {
        goToStep(4); // Pas de blocage strict, on fait confiance
    }

    function addMesure() {
        const div = document.createElement('div');
        div.className = 'hypo-item';
        div.innerHTML = '<input type="text" placeholder="Test..."><input type="text" placeholder="Valeur" style="width:100px;">';
        document.getElementById('mesuresContainer').appendChild(div);
    }

    function validateStep4() {
        goToStep(5);
    }

    function validateStep5() {
        const r1 = document.getElementById('remise1').checked;
        const r2 = document.getElementById('remise2').checked;
        const r3 = document.getElementById('remise3').checked;
        
        if(!r1 || !r2 || !r3) {
            if(!confirm("Certains points de remise en service ne sont pas coch√©s. Terminer quand m√™me ?")) return;
        }
        
        document.getElementById('finalTime').textContent = document.getElementById('totalTimer').textContent;
        goToStep(6);
    }

    // PDF EXPORT
    async function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(20);
        doc.text("RAPPORT D'INTERVENTION E32", 20, 20);
        
        doc.setFontSize(12);
        doc.text(`Technicien : ${document.getElementById('eleveNom').value}`, 20, 40);
        doc.text(`Support : ${document.getElementById('systemeNom').value}`, 20, 50);
        doc.text(`Temps total : ${document.getElementById('finalTime').textContent}`, 20, 60);
        
        doc.text("--- Analyse ---", 20, 80);
        doc.text(document.getElementById('analyseText').value, 20, 90);
        
        doc.save("Rapport_E32.pdf");
    }
</script>

</body>
</html>
