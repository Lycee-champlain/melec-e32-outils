<script>
    let currentStep = 0;
    let totalTime = 0;
    let timers = {};
    let startTime = Date.now();
    const stepIds = ['step0', 'step1', 'step2', 'step3', 'step4', 'step5', 'step6'];

    // Timer global
    setInterval(() => {
        totalTime = Math.floor((Date.now() - startTime) / 1000);
        document.getElementById('totalTimer').textContent = "Temps total : " + formatTime(totalTime);
    }, 1000);

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // Gestion Étape 1 : Sécurité
    function checkSecurity1() {
        const checks = ['s1-1', 's1-2', 's1-3'];
        const complete = checks.every(id => document.getElementById(id).checked);
        const feedback = document.getElementById('feedback1');
        
        if (complete) {
            feedback.innerHTML = '<div class="feedback success">Sécurité validée ! Passage à l\'étape 2...</div>';
            setTimeout(() => unlockStep(2), 1000);
        } else {
            feedback.innerHTML = '';
        }
    }

    // Gestion Étape 3 : Hypothèses (CORRIGÉE)
    function addHypo() {
        const div = document.createElement('div');
        div.className = 'hypo';
        div.innerHTML = `
            <input type="text" placeholder="Hypothèse..." class="hypo-input" style="width:70%; padding:8px; margin:5px 0;">
            <button class="btn btn-danger" onclick="deleteHypo(this)" style="padding:5px 10px;">X</button>
        `;
        document.getElementById('hypotheses').appendChild(div);
        checkHypoCount();
    }

    function deleteHypo(btn) {
        btn.parentElement.remove();
        checkHypoCount();
    }

    function checkHypoCount() {
        // Débloque l'étape 4 si au moins 1 hypothèse est présente
        const count = document.querySelectorAll('.hypo').length;
        const btnNext = document.getElementById('btnNextStep3');
        
        if (!btnNext && count > 0) {
            // Créer le bouton de validation s'il n'existe pas encore
            const btn = document.createElement('button');
            btn.id = 'btnNextStep3';
            btn.className = 'btn btn-success';
            btn.textContent = 'VALIDER HYPOTHÈSES -> ÉTAPE 4';
            btn.onclick = () => unlockStep(4);
            document.querySelector('#step3 .actions').appendChild(btn);
        } else if (btnNext && count === 0) {
            btnNext.remove();
        }
    }

    // Système de déverrouillage des étapes
    function unlockStep(n) {
        if (n <= currentStep) return; // Déjà débloqué
        
        // Marquer l'étape précédente comme terminée
        if (n > 0) {
            document.getElementById(stepIds[n-1]).classList.add('completed');
            document.getElementById(stepIds[n-1]).classList.remove('locked');
            stopStepTimer(n-1);
        }

        // Débloquer la nouvelle étape
        const nextStepEl = document.getElementById(stepIds[n]);
        if (nextStepEl) {
            nextStepEl.classList.remove('locked');
            // Scroll doux vers l'étape
            nextStepEl.scrollIntoView({behavior: 'smooth'});
            startStepTimer(n);
            currentStep = n;
            updateProgress();
        }
    }

    // Démarrage initial
    function startStep1() {
        const nom = document.getElementById('nomEtape0').value;
        if(nom.length < 2) {
            alert("Merci d'indiquer votre nom avant de commencer.");
            return;
        }
        unlockStep(1);
    }

    // Timers par étape
    function startStepTimer(stepNum) {
        if (timers[stepNum]) return;
        
        const start = Date.now();
        timers[stepNum] = setInterval(() => {
            const el = document.getElementById('timer' + stepNum);
            if (el) {
                const elapsed = Math.floor((Date.now() - start) / 1000);
                el.textContent = "Étape " + stepNum + " : " + formatTime(elapsed);
            }
        }, 1000);
    }

    function stopStepTimer(stepNum) {
        if (timers[stepNum]) {
            clearInterval(timers[stepNum]);
            // On pourrait geler l'affichage ici
        }
    }

    function updateProgress() {
        const pct = (currentStep / 6) * 100;
        document.getElementById('progressFill').style.width = pct + '%';
        document.getElementById('progressText').textContent = 'Étape ' + currentStep + '/6';
    }

    // Étape 4 : Déblocage auto après saisie mesures (optionnel)
    // Ajoute un bouton manuel pour passer à l'étape 5
    // Insère ce bouton dans le HTML de l'étape 4 si absent

    // Fonction d'urgence
    function emergencyStop() {
        document.body.innerHTML = '<h1 style="color:red;text-align:center;margin-top:20%">⛔ ARRÊT D\'URGENCE ENCLENCHÉ ⛔<br><br>Appelez le professeur immédiatement.</h1>';
    }

    // PDF Export (simplifié)
    async function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(22);
        doc.text("RAPPORT D'INTERVENTION E32", 20, 20);
        
        doc.setFontSize(12);
        doc.text("Élève : " + document.getElementById('nomEtape0').value, 20, 40);
        doc.text("Temps total : " + formatTime(totalTime), 20, 50);
        
        const analyse = document.getElementById('analyse').value;
        doc.text("Analyse : " + analyse, 20, 70);
        
        doc.save("Rapport_E32.pdf");
    }

    // Initialisation
    // Ajout des boutons manquants dans le HTML via JS pour corriger l'existant
    window.onload = function() {
        // Ajouter un container d'actions à l'étape 3 si absent
        if (!document.querySelector('#step3 .actions')) {
            const div = document.createElement('div');
            div.className = 'actions';
            document.getElementById('step3').appendChild(div);
        }
        
        // Ajout bouton validation étape 2 (Analyse)
        const step2 = document.getElementById('step2');
        if (!step2.querySelector('.btn-success')) {
            const btn = document.createElement('button');
            btn.className = 'btn btn-success';
            btn.textContent = 'Valider Analyse -> Étape 3';
            btn.style.marginTop = '10px';
            btn.onclick = () => unlockStep(3);
            step2.appendChild(btn);
        }

        // Ajout bouton validation étape 4 (Mesures)
        const step4 = document.getElementById('step4');
        if (!step4.querySelector('.btn-success')) {
            const btn = document.createElement('button');
            btn.className = 'btn btn-success';
            btn.textContent = 'Valider Mesures -> Étape 5';
            btn.style.marginTop = '10px';
            btn.onclick = () => unlockStep(5);
            step4.appendChild(btn);
        }

        // Ajout bouton validation étape 5 (Remise en service)
        const step5 = document.getElementById('step5');
        if (!step5.querySelector('.btn-success')) {
            const btn = document.createElement('button');
            btn.className = 'btn btn-success';
            btn.textContent = 'Valider Essais -> Étape 6';
            btn.style.marginTop = '10px';
            btn.onclick = () => unlockStep(6);
            step5.appendChild(btn);
        }
    };
</script>
