
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>E32 Maintenance | Application Pro</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb; /* Bleu intense */
            --primary-dark: #1e40af;
            --success: #10b981; /* Vert moderne */
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a; /* Bleu nuit tr√®s sombre */
            --gray: #64748b;
            --light: #f1f5f9;
            --white: #ffffff;
            --sidebar-width: 280px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #e2e8f0; color: #334155; height: 100vh; overflow: hidden; display: flex; }

        /* SIDEBAR */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--dark);
            color: var(--white);
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: 4px 0 10px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .brand { font-size: 20px; font-weight: 700; color: var(--white); margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .brand span { color: var(--primary); }

        .nav-steps { flex: 1; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; }
        .nav-item {
            display: flex; align-items: center; padding: 12px 15px; border-radius: 10px;
            color: #94a3b8; cursor: not-allowed; transition: all 0.3s; font-size: 14px; font-weight: 500;
        }
        .nav-item.active { background: var(--primary); color: var(--white); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4); }
        .nav-item.completed { color: var(--success); }
        .nav-item.completed::before { content: '‚úì'; margin-right: 8px; font-weight: bold; }
        .nav-number { width: 24px; height: 24px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 12px; }
        .nav-item.active .nav-number { background: var(--white); color: var(--primary); font-weight: bold; }

        .sidebar-footer { margin-top: auto; padding-top: 20px; border-top: 1px solid #334155; }
        .total-timer { font-family: 'Monaco', monospace; font-size: 24px; font-weight: 700; color: var(--warning); text-align: center; margin-bottom: 5px; }
        .total-label { text-align: center; font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }

        /* MAIN CONTENT */
        .main { flex: 1; padding: 30px; overflow-y: auto; position: relative; }

        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .page-title { font-size: 24px; font-weight: 700; color: var(--dark); }
        .user-info { display: flex; align-items: center; gap: 10px; background: var(--white); padding: 8px 16px; border-radius: 999px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .status-dot { width: 10px; height: 10px; background: var(--success); border-radius: 50%; animation: pulse 2s infinite; }

        /* STEPS CARDS */
        .step-card {
            background: var(--white); border-radius: 20px; padding: 40px;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
            max-width: 900px; margin: 0 auto;
            display: none; /* Masqu√© par d√©faut */
            animation: slideIn 0.4s ease-out;
        }
        .step-card.active { display: block; }

        .card-header { margin-bottom: 30px; border-bottom: 1px solid #e2e8f0; padding-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 22px; font-weight: 600; color: var(--dark); display: flex; align-items: center; gap: 12px; }
        .card-icon { font-size: 24px; }
        .step-timer { font-family: 'Monaco', monospace; font-size: 16px; color: var(--primary); background: #eff6ff; padding: 6px 12px; border-radius: 8px; }

        /* FORM ELEMENTS */
        .form-group { margin-bottom: 20px; }
        label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--gray); }
        input[type="text"], textarea {
            width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px;
            font-size: 16px; transition: all 0.3s; font-family: 'Inter', sans-serif;
        }
        input:focus, textarea:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

        .checklist-item {
            background: #f8fafc; border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px;
            margin-bottom: 10px; display: flex; align-items: center; cursor: pointer; transition: all 0.2s;
        }
        .checklist-item:hover { border-color: var(--primary); background: #eff6ff; }
        .checklist-item input { width: 20px; height: 20px; margin-right: 15px; accent-color: var(--primary); }
        .checklist-item span { font-size: 15px; font-weight: 500; }

        /* BUTTONS */
        .btn-action {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .btn-primary { background: var(--primary); color: var(--white); box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .btn-success { background: var(--success); color: var(--white); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
        .btn-success:hover { background: #059669; transform: translateY(-2px); }
        .btn-outline { background: transparent; border: 2px solid #e2e8f0; color: var(--gray); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }

        .dynamic-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .dynamic-item { display: flex; gap: 10px; animation: fadeIn 0.3s; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* RESPONSIVE */
        @media (max-width: 900px) {
            body { flex-direction: column; height: auto; overflow: auto; }
            .sidebar { width: 100%; flex-direction: row; align-items: center; padding: 10px 20px; position: sticky; top: 0; }
            .nav-steps { display: none; } /* Masquer √©tapes sur mobile pour gagner place */
            .sidebar-footer { display: none; }
            .main { padding: 20px; }
            .step-card { padding: 20px; }
        }
    </style>
</head>
<body>

    <!-- SIDEBAR NAVIGATION -->
    <nav class="sidebar">
        <div class="brand">
            ‚ö° <span>MELEC APP</span>
        </div>
        <div class="nav-steps">
            <div class="nav-item active" id="nav0"><span class="nav-number">0</span> Pr√©paration</div>
            <div class="nav-item" id="nav1"><span class="nav-number">1</span> Consignation</div>
            <div class="nav-item" id="nav2"><span class="nav-number">2</span> Analyse</div>
            <div class="nav-item" id="nav3"><span class="nav-number">3</span> Hypoth√®ses</div>
            <div class="nav-item" id="nav4"><span class="nav-number">4</span> Mesures</div>
            <div class="nav-item" id="nav5"><span class="nav-number">5</span> Remise en service</div>
            <div class="nav-item" id="nav6"><span class="nav-number">6</span> Rapport</div>
        </div>
        <div class="sidebar-footer">
            <div class="total-timer" id="globalTimer">00:00</div>
            <div class="total-label">Temps total</div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main">
        <div class="top-bar">
            <div class="page-title">Maintenance Corrective E32</div>
            <div class="user-info">
                <div class="status-dot"></div>
                <span id="headerEleve">Non identifi√©</span>
            </div>
        </div>

        <!-- STEP 0 -->
        <div class="step-card active" id="step0">
            <div class="card-header">
                <div class="card-title"><span class="card-icon">üìã</span> Pr√©paration de l'intervention</div>
            </div>
            <div class="form-group">
                <label>Nom du technicien (√âl√®ve)</label>
                <input type="text" id="inputNom" placeholder="Entrez votre nom..." autofocus>
            </div>
            <div class="form-group">
                <label>Syst√®me / Support technique</label>
                <input type="text" id="inputSysteme" placeholder="Ex: TGBT Atelier, Malaxeur...">
            </div>
            <button class="btn-action btn-primary" onclick="validateStep0()">Commencer l'intervention üöÄ</button>
        </div>

        <!-- STEP 1 -->
        <div class="step-card" id="step1">
            <div class="card-header">
                <div class="card-title"><span class="card-icon">üîí</span> Mise en s√©curit√©</div>
                <div class="step-timer" id="timer1">00:00</div>
            </div>
            <div class="checklist-item" onclick="toggleCheck('secu1')">
                <input type="checkbox" id="secu1" onchange="checkSecu()">
                <span>J'ai re√ßu l'autorisation d'acc√®s (Bon de travail sign√©)</span>
            </div>
            <div class="checklist-item" onclick="toggleCheck('secu2')">
                <input type="checkbox" id="secu2" onchange="checkSecu()">
                <span>Je porte mes EPI (Gants isolants, √âcran facial, Tapis)</span>
            </div>
            <div class="checklist-item" onclick="toggleCheck('secu3')">
                <input type="checkbox" id="secu3" onchange="checkSecu()">
                <span>J'ai effectu√© la VAT (V√©rification d'Absence de Tension)</span>
            </div>
            <div id="btnSecuContainer" style="margin-top:20px;"></div>
        </div>

        <!-- STEP 2 -->
        <div class="step-card" id="step2">
            <div class="card-header">
                <div class="card-title"><span class="card-icon">üîç</span> Analyse du probl√®me</div>
                <div class="step-timer" id="timer2">00:00</div>
            </div>
            <div class="form-group">
                <label>Observation des sympt√¥mes et analyse fonctionnelle :</label>
                <textarea id="analyseText" rows="6" placeholder="D√©crivez ce que vous observez (le moteur ne tourne pas, disjoncteur d√©clench√©...)"></textarea>
            </div>
            <button class="btn-action btn-success" onclick="validateStep2()">Valider l'analyse</button>
        </div>

        <!-- STEP 3 -->
        <div class="step-card" id="step3">
            <div class="card-header">
                <div class="card-title"><span class="card-icon">üí°</span> Hypoth√®ses de panne</div>
                <div class="step-timer" id="timer3">00:00</div>
            </div>
            <div class="dynamic-list" id="hypoContainer">
                <div class="dynamic-item">
                    <input type="text" placeholder="Hypoth√®se 1 (ex: Fusible F1 HS)">
                </div>
            </div>
            <button class="btn-action btn-outline" onclick="addHypo()" style="margin-bottom:15px;">+ Ajouter une hypoth√®se</button>
            <button class="btn-action btn-success" onclick="goToStep(4)">Valider les hypoth√®ses</button>
        </div>

        <!-- STEP 4 -->
        <div class="step-card" id="step4">
            <div class="card-header">
                <div class="card-title"><span class="card-icon">‚ö°</span> Mesures et Tests</div>
                <div class="step-timer" id="timer4">00:00</div>
            </div>
            <div class="dynamic-list" id="mesuresContainer">
                <div class="dynamic-item">
                    <input type="text" placeholder="Test (ex: Tension U1-U2)" style="flex:2;">
                    <input type="text" placeholder="Valeur" style="flex:1;">
                </div>
            </div>
            <button class="btn-action btn-outline" onclick="addMesure()" style="margin-bottom:15px;">+ Ajouter une mesure</button>
            <button class="btn-action btn-success" onclick="goToStep(5)">Valider les mesures</button>
        </div>

        <!-- STEP 5 -->
        <div class="step-card" id="step5">
            <div class="card-header">
                <div class="card-title"><span class="card-icon">‚úÖ</span> Remise en service</div>
                <div class="step-timer" id="timer5">00:00</div>
            </div>
            <div class="checklist-item" onclick="toggleCheck('remise1')">
                <input type="checkbox" id="remise1">
                <span>Zone nettoy√©e et outils rang√©s</span>
            </div>
            <div class="checklist-item" onclick="toggleCheck('remise2')">
                <input type="checkbox" id="remise2">
                <span>Protections remises en place (plastrons, portes)</span>
            </div>
            <div class="checklist-item" onclick="toggleCheck('remise3')">
                <input type="checkbox" id="remise3">
                <span>Essai de fonctionnement concluant</span>
            </div>
            <button class="btn-action btn-success" onclick="validateStep5()" style="margin-top:20px;">Terminer l'intervention üèÅ</button>
        </div>

        <!-- STEP 6 -->
        <div class="step-card" id="step6">
            <div class="card-header">
                <div class="card-title"><span class="card-icon">üìÑ</span> Rapport d'intervention</div>
            </div>
            <div style="background: #ecfdf5; border: 1px solid #10b981; padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 30px;">
                <h3 style="color: #064e3b; margin-bottom: 10px; font-size: 24px;">F√©licitations !</h3>
                <p style="color: #065f46; font-size: 18px;">Intervention termin√©e en <span id="finalTime" style="font-weight:bold;">00:00</span></p>
            </div>
            <button class="btn-action btn-primary" onclick="generatePDF()">T√©l√©charger le rapport PDF üì•</button>
        </div>

    </main>

    <script>
        // LOGIQUE JS ROBUSTE
        let currentStep = 0;
        let startTime = null;
        let stepTimers = {};
        let intervalGlobal = null;

        // Fonction Utilitaires
        function toggleCheck(id) {
            const el = document.getElementById(id);
            // el.checked = !el.checked; // Conflit avec le click natif checkbox, on laisse g√©rer par le label/input
            if(id.startsWith('secu')) checkSecu();
        }

        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = s % 60;
            return `${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        }

        function startGlobalTimer() {
            startTime = Date.now();
            intervalGlobal = setInterval(() => {
                const totalSeconds = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('globalTimer').textContent = formatTime(totalSeconds);

                // Timer √©tape
                if(currentStep > 0 && currentStep < 6) {
                    const el = document.getElementById('timer' + currentStep);
                    if(el) {
                        if(!stepTimers[currentStep]) stepTimers[currentStep] = Date.now();
                        const stepSeconds = Math.floor((Date.now() - stepTimers[currentStep]) / 1000);
                        el.textContent = formatTime(stepSeconds);
                    }
                }
            }, 1000);
        }

        function goToStep(n) {
            // Masquer √©tape actuelle
            document.getElementById('step' + currentStep).classList.remove('active');

            // Sidebar update
            const navOld = document.getElementById('nav' + currentStep);
            if(navOld) {
                navOld.classList.remove('active');
                navOld.classList.add('completed');
            }

            // Afficher nouvelle √©tape
            currentStep = n;
            const nextCard = document.getElementById('step' + n);
            nextCard.classList.add('active');

            // Sidebar active
            const navNew = document.getElementById('nav' + n);
            if(navNew) {
                navNew.classList.add('active');
                navNew.scrollIntoView({behavior: 'smooth', block: 'center'});
            }

            // Init timer √©tape si pas d√©j√† fait
            if(!stepTimers[n]) stepTimers[n] = Date.now();
        }

        // VALIDATIONS
        function validateStep0() {
            const nom = document.getElementById('inputNom').value;
            if(nom.length < 2) { alert("Nom requis !"); return; }
            document.getElementById('headerEleve').textContent = nom;
            startGlobalTimer();
            goToStep(1);
        }

        function checkSecu() {
            const s1 = document.getElementById('secu1').checked;
            const s2 = document.getElementById('secu2').checked;
            const s3 = document.getElementById('secu3').checked;
            const btnContainer = document.getElementById('btnSecuContainer');

            if(s1 && s2 && s3) {
                btnContainer.innerHTML = `<button class="btn-action btn-success" onclick="goToStep(2)">S√©curit√© OK - Continuer</button>`;
            } else {
                btnContainer.innerHTML = '';
            }
        }

        function validateStep2() {
            if(document.getElementById('analyseText').value.length < 5) {
                alert("Analyse requise !"); return;
            }
            goToStep(3);
        }

        function addHypo() {
            const div = document.createElement('div');
            div.className = 'dynamic-item';
            div.innerHTML = `<input type="text" placeholder="Nouvelle hypoth√®se...">`;
            document.getElementById('hypoContainer').appendChild(div);
        }

        function addMesure() {
            const div = document.createElement('div');
            div.className = 'dynamic-item';
            div.innerHTML = `<input type="text" placeholder="Test" style="flex:2;"> <input type="text" placeholder="Valeur" style="flex:1;">`;
            document.getElementById('mesuresContainer').appendChild(div);
        }

        function validateStep5() {
            if(!document.getElementById('remise1').checked || !document.getElementById('remise2').checked) {
                if(!confirm("Attention, remise en service incompl√®te. Continuer ?")) return;
            }
            clearInterval(intervalGlobal); // Arr√™t timer
            document.getElementById('finalTime').textContent = document.getElementById('globalTimer').textContent;
            goToStep(6);
        }

        // PDF GENERATION PRO
        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header Pro
            doc.setFillColor(37, 99, 235); // Bleu primaire
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.text("RAPPORT D'INTERVENTION E32", 20, 25);
            doc.setFontSize(10);
            doc.text("BAC PRO MELEC - Maintenance Corrective", 20, 35);

            // Info
            doc.setTextColor(50, 50, 50);
            doc.setFontSize(12);
            doc.text(`Technicien : ${document.getElementById('inputNom').value}`, 20, 60);
            doc.text(`Date : ${new Date().toLocaleDateString()}`, 150, 60);
            doc.text(`Support : ${document.getElementById('inputSysteme').value}`, 20, 70);
            doc.text(`Dur√©e : ${document.getElementById('finalTime').textContent}`, 150, 70);

            // Contenu
            doc.setDrawColor(200, 200, 200);
            doc.line(20, 80, 190, 80);

            doc.setFontSize(14);
            doc.setTextColor(37, 99, 235);
            doc.text("1. Analyse du dysfonctionnement", 20, 95);
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            const splitAnalyse = doc.splitTextToSize(document.getElementById('analyseText').value, 170);
            doc.text(splitAnalyse, 20, 105);

            doc.save("Rapport_Intervention_E32.pdf");
        }
    </script>
</body>
</html>
